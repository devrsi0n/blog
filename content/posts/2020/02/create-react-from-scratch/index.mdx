---
title: "âš›ï¸ Re: ä»é›¶å¼€å§‹çš„ React å†é€ ä¹‹æ—…"
author: devrsi0n
date: 2020-02-04
excerpt: ä¸ä¾èµ–ä»»ä½•ç¬¬ä¸‰æ–¹åŒ…ï¼Œä»é›¶å¼€å§‹åŠ¨æ‰‹é€  React
hero: ./images/hero.jpeg
heroRef: <a href="https://zh.ifixit.com/Guide/MacBook+Pro+16-Inch+2019+%E6%8B%86%E8%A7%A3/128106">IFIX</a>
tags: ['react', 'frontend', 'JavaScript']
---

React æ˜¯ç›®å‰æœ€æµè¡Œçš„å‰ç«¯æ¡†æ¶ï¼Œå¾ˆå¤šè¯»è€…ç”¨ React å¾ˆæºœï¼Œä½†æƒ³è¦æ·±å…¥å­¦ä¹  React çš„åŸç†å°±ä¼šè¢«å®˜æ–¹æºç ä»“åº“ä»£ç ç»•çš„æ™•å¤´è½¬å‘ã€‚ä»Šå¤©æˆ‘ä»¬é€šè¿‡ä¸ä¾èµ–ä»»ä½•ç¬¬ä¸‰æ–¹åº“çš„æ–¹å¼ï¼ŒæŠ›å¼ƒè¾¹ç•Œå¤„ç†ã€æ€§èƒ½ä¼˜åŒ–ã€å®‰å…¨æ€§ç­‰å¼±ç›¸å…³ä»£ç æ‰‹å†™ä¸€ä¸ªåŸºç¡€ç‰ˆçš„ Reactï¼Œä¾›å¤§å®¶å­¦ä¹ å’Œç†è§£ React çš„æ ¸å¿ƒåŸç†ã€‚

![feynman](./images/feynman.png)

æœ¬æ–‡å®ç°çš„æ˜¯åŒ…å«ç°ä»£ React æœ€æ–°ç‰¹æ€§ [Hooks](https://reactjs.org/docs/hooks-intro.html) å’Œ [Concurrent Mode](https://reactjs.org/docs/concurrent-mode-intro.html) çš„ç‰ˆæœ¬ï¼Œä¼ ç»Ÿ class ç»„ä»¶çš„æ–¹å¼ç¨æœ‰ä¸åŒï¼Œä¸å½±å“ç†è§£æ ¸å¿ƒåŸç†ã€‚æœ¬æ–‡å‡½æ•°ã€å˜é‡ç­‰æ ‡è¯†ç¬¦å‘½åéƒ½å’Œå®˜æ–¹å°½é‡è´´è¿‘ï¼Œæ–¹ä¾¿ä»¥åæ·±å…¥å®˜æ–¹æºç ã€‚

å»ºè®®æ¡Œé¢ç«¯æµè§ˆæœ¬æ–‡ï¼Œå¹¶ä¸”è·Ÿç€æ–‡ç« æ‰‹åŠ¨æ•²ä¸€éä»£ç åŠ æ·±ç†è§£ã€‚æ¯å®Œæˆä¸€ä¸ªå®Œæ•´åŠŸèƒ½æœ€åéƒ½ä¼šæœ‰å¯¹åº”çš„å®Œæ•´ä»£ç æ”¾åœ¨ [CodeSandboxï¼ˆåœ¨çº¿å¼€å‘ç¯å¢ƒï¼‰](https://codesandbox.io/)ï¼Œå¦‚æœå¯¹ä»£ç æœ‰ç–‘é—®ï¼Œå¯ä»¥å…ˆæŸ¥çœ‹å®Œæ•´ä»£ç ï¼Œæ‰“æ–­ç‚¹è°ƒè¯•ä¸‹ã€‚

**ç›®å½•æ€»è§ˆ**

- 0: ä»ä¸€æ¬¡æœ€ç®€å•çš„ React æ¸²æŸ“è¯´èµ·
- I: å®ç° createElement å‡½æ•°
- II: å®ç° render å‡½æ•°
- III: å¹¶å‘æ¨¡å¼ / Concurrent Mode
- IV: Fibers æ•°æ®ç»“æ„
- V: render å’Œ commit é˜¶æ®µ
- VI: æ›´æ–°å’Œåˆ é™¤èŠ‚ç‚¹/Reconciliation
- VII: å‡½æ•°ç»„ä»¶
- VIII: å‡½æ•°ç»„ä»¶ Hooks

## 0: ä»ä¸€æ¬¡æœ€ç®€å•çš„ React æ¸²æŸ“è¯´èµ·

```jsx
const element = <h1 title="hello">Hello World!</h1>;
const container = document.getElementById("root");
ReactDOM.render(element, container);
```

ä¸Šé¢è¿™ä¸‰è¡Œä»£ç æ˜¯ä¸€ä¸ªå†ç®€å•ä¸è¿‡çš„ React åº”ç”¨ï¼šåœ¨ `root` æ ¹ç»“ç‚¹ä¸Šæ¸²æŸ“ä¸€ä¸ª `Hello World!` h1 èŠ‚ç‚¹ã€‚

ç¬¬ä¸€æ­¥çš„ç›®æ ‡æ˜¯**ç”¨åŸç”Ÿ DOM æ–¹å¼æ›¿æ¢ React ä»£ç **ã€‚

### JSX

ç†Ÿæ‚‰ React çš„è¯»è€…éƒ½çŸ¥é“ï¼Œæˆ‘ä»¬ç›´æ¥åœ¨ç»„ä»¶æ¸²æŸ“çš„æ—¶å€™è¿”å›ä¸€æ®µç±»ä¼¼ html æ¨¡ç‰ˆçš„ç»“æ„ï¼Œè¿™ä¸ªå°±æ˜¯æ‰€è°“çš„ [JSX](https://reactjs.org/docs/introducing-jsx.html)ã€‚JSX æœ¬è´¨ä¸Šè¿˜æ˜¯ JSï¼Œæ˜¯è¯­æ³•ç³–è€Œä¸æ˜¯ html æ¨¡ç‰ˆï¼ˆç›¸æ¯” html æ¨¡ç‰ˆè¦å­¦ä¹ åƒå¥‡ç™¾æ€ªçš„è¯­æ³•æ¯”å¦‚ï¼š`{{#if value}}`ï¼ŒJSX å¯ä»¥ç›´æ¥ä½¿ç”¨ JS åŸç”Ÿçš„ `&& || map reduce` ç­‰è¯­æ³•æ›´æ˜“å­¦è¡¨è¾¾èƒ½åŠ›ä¹Ÿæ›´å¼ºï¼‰ã€‚ä¸€èˆ¬éœ€è¦ [babel](https://babeljs.io/) é…åˆ[@babel/plugin-transform-react-jsx](https://babeljs.io/docs/en/babel-plugin-transform-react-jsx) æ’ä»¶ï¼ˆbabel è½¬æ¢è¿‡ç¨‹ä¸æ˜¯æœ¬æ–‡é‡ç‚¹ï¼Œæ„Ÿå…´è¶£å¯ä»¥é˜…è¯»[æ’ä»¶æºç ](https://github.com/babel/babel/blob/master/packages/babel-plugin-transform-react-jsx/README.md#babelplugin-transform-react-jsx)ï¼‰è½¬æ¢æˆè°ƒç”¨ `React.createElement`ï¼Œå‡½æ•°å…¥å‚å¦‚ä¸‹ï¼š

```js
React.createElement(
  type,
  [props],
  [...children]
)
```

ä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­ä¸­çš„ `<h1 title="hello">Hello World!</h1>`ï¼Œæ¢æˆ `createElement` è°ƒç”¨å°±æ˜¯ï¼š

```js
const element = React.createElement(
  'h1',
  { title: 'hello' },
  'Hello World!'
);
```

`React.createElement` è¿”å›ä¸€ä¸ªåŒ…å«å…ƒç´ ï¼ˆelementï¼‰ä¿¡æ¯çš„å¯¹è±¡ï¼Œå³ï¼š

```js
const element = {
  type: "h1",
  props: {
    title: "hello",
    // createElement ç¬¬ä¸‰ä¸ªåŠä¹‹åå‚æ•°ç§»åˆ° props.children
    children: "Hello World!",
  },
};
```

react å®˜æ–¹å®ç°è¿˜åŒ…æ‹¬äº†å¾ˆå¤šé¢å¤–å±æ€§ï¼Œç®€å•èµ·è§æœ¬æ–‡æœªæ¶‰åŠï¼Œå‚çœ‹[å®˜æ–¹å®šä¹‰](https://github.com/facebook/react/blob/f4cc45ce962adc9f307690e1d5cfa28a288418eb/packages/react/src/ReactElement.js#L111)ã€‚

è¿™ä¸ªå¯¹è±¡æè¿°äº† React åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼ˆnodeï¼‰æ‰€éœ€è¦çš„ä¿¡æ¯ï¼Œ`type` å°±æ˜¯ DOM èŠ‚ç‚¹çš„åå­—ï¼Œæ¯”å¦‚è¿™é‡Œæ˜¯ `h1`ï¼Œä¹Ÿå¯ä»¥æ˜¯å‡½æ•°ç»„ä»¶ï¼Œåé¢ä¼šè®²åˆ°ã€‚`props` åŒ…å«æ‰€æœ‰å…ƒç´ çš„å±æ€§ï¼ˆæ¯”å¦‚ titleï¼‰å’Œç‰¹æ®Šå±æ€§ childrenï¼Œchildren å¯ä»¥åŒ…å«å…¶ä»–å…ƒç´ ï¼Œä»æ ¹åˆ°å¶ä¹Ÿå°±èƒ½æ„æˆä¸€é¢—å®Œæ•´çš„æ ‘ï¼Œä¹Ÿå°±æ˜¯æè¿°äº†æ•´ä¸ª UI ç•Œé¢ã€‚

**ä¸ºäº†é¿å…å«ä¹‰ä¸æ¸…ï¼Œâ€œå…ƒç´ â€ç‰¹æŒ‡ â€œReact elementsâ€ï¼Œâ€œèŠ‚ç‚¹â€ç‰¹æŒ‡ â€œDOM elementsâ€ã€‚**

### ReactDOM.render

ä¸‹é¢æ›¿æ¢æ‰ `ReactDOM.render` è°ƒç”¨ï¼Œè¿™é‡Œ React ä¼šæŠŠå…ƒç´ æ›´æ–°åˆ° DOMã€‚

```js
const element = {
  type: "h1",
  props: {
    title: "hello",
    children: ["Hello World!"],
  },
};
â€‹
const container = document.getElementById("root");
â€‹
const node = document.createElement(element.type);
node["title"] = element.props.title;
â€‹
const text = document.createTextNode("");
text["nodeValue"] = element.props.children;
â€‹
node.appendChild(text);
container.appendChild(node);
```

å¯¹æ¯”å…ƒç´ å¯¹è±¡ï¼Œé¦–å…ˆç”¨ `element.type` åˆ›å»ºèŠ‚ç‚¹ï¼Œå†æŠŠé children å±æ€§ï¼ˆè¿™é‡Œæ˜¯ titleï¼‰èµ‹å€¼ç»™èŠ‚ç‚¹ã€‚

ç„¶ååˆ›å»º children èŠ‚ç‚¹ï¼Œç”±äº children æ˜¯å­—ç¬¦ä¸²ï¼Œæ•…åˆ›å»º `textNode` èŠ‚ç‚¹ï¼Œå¹¶æŠŠå­—ç¬¦ä¸²èµ‹å€¼ç»™ `nodeValue`ï¼Œè¿™é‡Œä¹‹æ‰€ä»¥ç”¨ `createTextNode` è€Œä¸æ˜¯ `innerText`ï¼Œæ˜¯ä¸ºäº†æ–¹ä¾¿ä¹‹åç»Ÿä¸€å¤„ç†ã€‚

å†æŠŠ children èŠ‚ç‚¹ text æ’åˆ°å…ƒç´ èŠ‚ç‚¹çš„å­èŠ‚ç‚¹ä¸Šï¼Œæœ€åæŠŠå…ƒç´ èŠ‚ç‚¹æ’åˆ°æ ¹ç»“ç‚¹å³å®Œæˆäº†è¿™æ¬¡ React çš„æ›¿æ¢ã€‚

<Message>

åƒä¸Šé¢ä»£ç  `element` è¿™æ · JSX è½¬æˆçš„æè¿° UI ç•Œé¢çš„å¯¹è±¡å°±æ˜¯æ‰€è°“çš„ **è™šæ‹Ÿ DOM**ï¼Œç›¸å¯¹çš„ `node` å³ **çœŸå® DOM**ã€‚`render/æ¸²æŸ“` è¿‡ç¨‹å°±æ˜¯æŠŠè™šæ‹Ÿ DOM è½¬æ¢æˆçœŸå® DOM çš„è¿‡ç¨‹ã€‚

</Message>

---

## I: å®ç° createElement å‡½æ•°

ç¬¬ä¸€æ­¥é¦–å…ˆå®ç° `createElement` å‡½æ•°ï¼ŒæŠŠ JSX è½¬æ¢æˆ JSã€‚ä»¥ä¸‹é¢è¿™ä¸ªæ–°çš„æ¸²æŸ“ä¸ºä¾‹ï¼Œ`createElement` å°±æ˜¯æŠŠ JSX ç»“æ„è½¬æˆå…ƒç´ æè¿°å¯¹è±¡ã€‚

```jsx
const element = (
  <div id="foo">
    <a>bar</a>
    <b />
  </div>
);
// ç­‰ä»·è½¬æ¢ ğŸ‘‡
const element = React.createElement(
  "div",
  { id: "foo" },
  React.createElement("a", null, "bar"),
  React.createElement("b")
);

const container = document.getElementById("root");
ReactDOM.render(element, container);
```

å°±åƒä¹‹å‰ç¤ºä¾‹é‚£æ ·ï¼Œ`createElement` è¿”å›ä¸€ä¸ªåŒ…å« type å’Œ props çš„å…ƒç´ å¯¹è±¡ï¼Œæè¿°èŠ‚ç‚¹ä¿¡æ¯ã€‚

```js
// è¿™é‡Œç”¨äº†æœ€æ–° ECMAScript å‰©ä½™å‚æ•°å’Œå±•å¼€è¯­æ³•ï¼ˆRest parameter/Spread syntaxï¼‰ï¼Œ
// å‚è€ƒ https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Operators/Spread_syntax
// æ³¨æ„ï¼šè¿™é‡Œ children å§‹ç»ˆæ˜¯æ•°ç»„
function createElement(type, props, ...children) {
  return {
    type,
    props: {
      ...props,
      children: children.map(child =>
        typeof child === "object"
          ? child
          : createTextElement(child)
      ),
    },
  }
}
â€‹
function createTextElement(text) {
  return {
    type: "TEXT_ELEMENT",
    props: {
      nodeValue: text,
      children: [],
    },
  }
}
```

children å¯èƒ½åŒ…å«å­—ç¬¦ä¸²æˆ–è€…æ•°å­—è¿™ç±»åŸºç¡€ç±»å‹å€¼ï¼Œç»™è¿™é‡Œå€¼åŒ…è£¹æˆ `TEXT_ELEMENT` ç‰¹æ®Šç±»å‹ï¼Œæ–¹ä¾¿åé¢ç»Ÿä¸€å¤„ç†ã€‚

<Message>

  æ³¨æ„ï¼šReact å¹¶ä¸ä¼šåŒ…è£¹å­—ç¬¦ä¸²è¿™ç±»å€¼ï¼Œå¦‚æœæ²¡æœ‰ children ä¹Ÿä¸ä¼šåˆ›å»ºç©ºæ•°ç»„ï¼Œè¿™é‡Œç®€å•èµ·è§ï¼Œç»Ÿä¸€è¿™æ ·å¤„ç†å¯ä»¥ç®€åŒ–æˆ‘ä»¬çš„ä»£ç ã€‚

</Message>

æˆ‘ä»¬æŠŠæœ¬æ–‡çš„æ¡†æ¶å«åš `redact`ï¼Œä»¥åŒºåˆ« `react`ã€‚ç¤ºä¾‹ app å¦‚ä¸‹ã€‚

```js
const element = Redact.createElement(
  "div",
  { id: "foo" },
  Redact.createElement("a", null, "bar"),
  Redact.createElement("b")
);
const container = document.getElementById("root");
// åé¢å®ç° render æ–¹æ³•
RedactDOM.render(element, container);
```

ä½†æ˜¯æˆ‘ä»¬è¿˜æ˜¯ä¹ æƒ¯ç”¨ JSX æ¥å†™ç»„ä»¶ï¼Œè¿™é‡Œè¿˜èƒ½ç”¨å—ï¼Ÿç­”æ¡ˆæ˜¯èƒ½çš„ï¼Œåªéœ€è¦åŠ ä¸€è¡Œæ³¨é‡Šå³å¯ã€‚

```js
/** @jsx Redact.createElement */
const element = (
  <div id="foo">
    <a>bar</a>
    <b />
  </div>
);
const container = document.getElementById("root");
RedactDOM.render(element, container);
```

æ³¨æ„ç¬¬ä¸€è¡Œæ³¨é‡Š `@jsx` å‘Šè¯‰ babel ç”¨ `Redact.createElement` æ›¿æ¢é»˜è®¤çš„ `React.createElement`ã€‚æˆ–è€…ç›´æ¥ä¿®æ”¹ `.babelrc` é…ç½®æ–‡ä»¶çš„ `pragma` é¡¹ï¼Œå°±ä¸ç”¨æ¯ä¸ª JSX æ–‡ä»¶éƒ½æ·»åŠ æ³¨é‡Šäº†ã€‚

```json
{
  "presets": [
    [
      "@babel/preset-react",
      {
        "pragma": "Redact.createElement",
      }
    ]
  ]
}
```

---

## II: å®ç° render å‡½æ•°

å®ç°æˆ‘ä»¬çš„ render å‡½æ•°ï¼Œç›®å‰åªéœ€è¦æ·»åŠ èŠ‚ç‚¹åˆ° DOMï¼Œåˆ é™¤å’Œæ›´æ–°æ“ä½œåé¢å†åŠ ã€‚

```js
function render(element, container) {
  // åˆ›å»ºèŠ‚ç‚¹
  const dom =
    element.type === "TEXT_ELEMENT"
      ? document.createTextNode("")
      : document.createElement(element.type);
â€‹
  // èµ‹å€¼å±æ€§ï¼ˆpropsï¼‰
  const isProperty = key => key !== "children";
  Object.keys(element.props)
    .filter(isProperty)
    .forEach(name => {
      dom[name] = element.props[name]
    });

  // é€’å½’éå†å­èŠ‚ç‚¹
  element.props.children.forEach(child =>
    render(child, dom)
  );
â€‹
  // æ’å…¥çˆ¶èŠ‚ç‚¹
  container.appendChild(dom);
}
```

ä¸Šé¢çš„ä»£ç æ”¾åœ¨äº† CodeSandboxï¼ˆåœ¨çº¿å¼€å‘ç¯å¢ƒï¼‰ï¼Œé¡¹ç›®åŸºäº [Create React App](https://create-react-app.dev/docs/getting-started/) è„šæ‰‹æ¶ï¼Œè¯•ä¸€è¯•æ”¹ä¸‹é¢çš„ JSX ä»£ç éªŒè¯ä¸‹ã€‚

<iframe
  src="https://codesandbox.io/embed/adoring-lewin-93gyy?fontsize=14&hidenavigation=1&theme=dark"
  style="width: 100%;max-width: 800px;; height:500px; border:0; border-radius: 4px; overflow:hidden;"
  title="redact-1"
  allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb"
  sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"
></iframe>

---

## III: å¹¶å‘æ¨¡å¼ / Concurrent Mode

åœ¨æˆ‘ä»¬æ·±å…¥å…¶ä»– React åŠŸèƒ½ä¹‹å‰ï¼Œå…ˆå¯¹ä»£ç é‡æ„ï¼Œå¼•å…¥ React æœ€æ–°çš„å¹¶å‘æ¨¡å¼ï¼ˆæˆªæ­¢æœ¬æ–‡å‘è¡¨è¯¥åŠŸèƒ½è¿˜æœªæ­£å¼å‘å¸ƒï¼‰ã€‚

å¯èƒ½è¯»è€…ä¼šç–‘æƒ‘æˆ‘ä»¬ç›®å‰è¿æœ€åŸºæœ¬çš„ç»„ä»¶çŠ¶æ€æ›´æ–°éƒ½è¿˜æ²¡å®ç°å°±å…ˆå®ç°å¹¶å‘æ¨¡å¼ï¼Œå…¶å®ç›®å‰ä»£ç é€»è¾‘è¿˜ååˆ†ç®€å•ï¼Œç°åœ¨é‡æ„ï¼Œæ¯”ä¹‹åå®ç°æ‰€æœ‰åŠŸèƒ½å†å›å¤´è¦å®¹æ˜“å¾ˆå¤šï¼Œæ‰€è°“ç§¯é‡éš¾è¿”å°±æ˜¯è¿™ä¸ªé“ç†ã€‚

æœ‰ç»éªŒçš„å¼€å‘è€…å¾ˆå®¹æ˜“å‘ç°ä¸Šé¢çš„ `render` ä»£ç æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œæ¸²æŸ“å­èŠ‚ç‚¹æ—¶é€’å½’éå†äº†æ•´æ£µæ ‘ï¼Œå½“é¡µé¢éå¸¸å¤æ‚æ—¶å¾ˆå®¹æ˜“é˜»å¡ä¸»çº¿ç¨‹ï¼Œæˆ‘ä»¬éƒ½çŸ¥é“æ¯ä¸ªé¡µé¢æ˜¯å•çº¿ç¨‹çš„ï¼ˆä¸è€ƒè™‘ worker çº¿ç¨‹ï¼‰ï¼Œä¸»çº¿ç¨‹é˜»å¡ä¼šå¯¼è‡´é¡µé¢ä¸èƒ½åŠæ—¶å“åº”é«˜ä¼˜å…ˆçº§æ“ä½œï¼Œå¦‚ç”¨æˆ·ç‚¹å‡»äº‹ä»¶æˆ–è€…æ¸²æŸ“åŠ¨ç”»ï¼Œé¡µé¢ç»™ç”¨æˆ· â€œå¾ˆå¡ï¼Œéš¾ç”¨â€ çš„è´Ÿé¢å°è±¡ï¼Œè¿™è‚¯å®šä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚

å› æ­¤ï¼Œç†æƒ³æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥æŠŠ `render` æ‹†æˆæ›´ç»†åˆ†çš„å•å…ƒï¼Œæ¯å®Œæˆä¸€ä¸ªå•å…ƒçš„å·¥ä½œï¼Œå…è®¸æµè§ˆå™¨æ‰“æ–­æ¸²æŸ“å“åº”æ›´é«˜ä¼˜å…ˆçº§çš„çš„å·¥ä½œï¼Œè¿™ä¸ªè¿‡ç¨‹å³ â€œå¹¶å‘æ¨¡å¼â€ã€‚

è¿™é‡Œæˆ‘ä»¬ç”¨ [requestIdleCallback](https://developer.mozilla.org/en-US/docs/Web/API/Window/requestIdleCallback) è¿™ä¸ªæµè§ˆå™¨ API æ¥å®ç°ã€‚è¿™ä¸ª API æœ‰ç‚¹ç±»ä¼¼ `setTimeout`ï¼Œä¸è¿‡ä¸æ˜¯æˆ‘ä»¬å‘Šè¯‰æµè§ˆå™¨ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå›è°ƒå‡½æ•°ï¼Œè€Œæ˜¯æµè§ˆå™¨åœ¨çº¿ç¨‹ç©ºé—²ï¼ˆidleï¼‰çš„æ—¶ä¾¯ä¸»åŠ¨æ‰§è¡Œå›è°ƒå‡½æ•°ã€‚

React ç›®å‰å·²ç»[ä¸ç”¨è¿™ä¸ª API](https://github.com/facebook/react/issues/11171#issuecomment-417349573) äº†ï¼Œè€Œæ˜¯è‡ªå·±å®ç°è°ƒåº¦ç®—æ³• [è°ƒåº¦å™¨/scheduler](https://github.com/facebook/react/tree/master/packages/scheduler)ã€‚ä½†å®ƒä»¬æ ¸å¿ƒæ€è·¯æ˜¯ç±»ä¼¼çš„ï¼Œç®€åŒ–èµ·è§ç”¨ requestIdleCallback è¶³çŸ£ã€‚

```js
let nextUnitOfWork = null
â€‹
function workLoop(deadline) {
  let shouldYield = false;
  while (nextUnitOfWork && !shouldYield) {
    nextUnitOfWork = performUnitOfWork(
      nextUnitOfWork
    );
    // å›è°ƒå‡½æ•°å…¥å‚ deadline å¯ä»¥å‘Šè¯‰æˆ‘ä»¬åœ¨è¿™ä¸ªæ¸²æŸ“å‘¨æœŸè¿˜å‰©å¤šå°‘æ—¶é—´å¯ç”¨
    // å‰©ä½™æ—¶é—´å°äº1æ¯«ç§’å°±é€€å‡ºå›è°ƒï¼Œç­‰å¾…æµè§ˆå™¨å†æ¬¡ç©ºé—²
    shouldYield = deadline.timeRemaining() < 1;
  }
  requestIdleCallback(workLoop);
}
â€‹
requestIdleCallback(workLoop);
â€‹
// æ³¨æ„ï¼Œè¿™ä¸ªå‡½æ•°æ‰§è¡Œå®Œæœ¬æ¬¡å•å…ƒä»»åŠ¡ä¹‹åè¦è¿”å›ä¸‹ä¸€ä¸ªå•å…ƒä»»åŠ¡
function performUnitOfWork(nextUnitOfWork) {
  // TODO
}
```

è¿™å°±æ˜¯æˆ‘ä»¬ç®€æ˜“å¹¶å‘æ¨¡å¼çš„å®ç°ï¼Œæ¸²æŸ“ä»»åŠ¡æ‹†åˆ†ä¸ºå¤šä¸ªä»»åŠ¡å•å…ƒäº¤ç»™ `performUnitOfWork` æ‰§è¡Œï¼Œå…·ä½“æ€ä¹ˆæ‹†åˆ†ä»»åŠ¡ï¼Ÿç­”æ¡ˆæ˜¯ â€œFibersâ€ã€‚

## IV: Fibers æ•°æ®ç»“æ„

ä¸ºäº†æ–¹ä¾¿æè¿°æ¸²æŸ“æ ‘å’Œå•å…ƒä»»åŠ¡ï¼ŒReact è®¾è®¡äº†ä¸€ç§æ•°æ®ç»“æ„ â€œfiber æ ‘â€ã€‚æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ª fiberï¼Œæ¯ä¸ª fiber å°±æ˜¯ä¸€ä¸ªå•å…ƒä»»åŠ¡ã€‚

å‡å¦‚æˆ‘ä»¬æ¸²æŸ“å¦‚ä¸‹è¿™æ ·ä¸€æ£µæ ‘ï¼š

```js
Redact.render(
  <div>
    <h1>
      <p />
      <a />
    </h1>
    <h2 />
  </div>,
  container
)
```

ç”¨ Fiber æ ‘æ¥æè¿°å°±æ˜¯ï¼š

<div style="background:#202226;max-width: 680px;margin: 0 auto;">
  <img src="./images/fiber0.png"></img>
</div>

åœ¨ `render` å‡½æ•°æˆ‘ä»¬åˆ›å»º**æ ¹ fiber**ï¼Œå†æŠŠå®ƒè®¾ä¸º `nextUnitOfWork`ã€‚åœ¨ workLoop å‡½æ•°æŠŠ `nextUnitOfWork` ç»™ `performUnitOfWork` æ‰§è¡Œï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹ä¸‰æ­¥ï¼š

1. æŠŠå…ƒç´ æ·»åŠ åˆ° DOM
2. ä¸ºå…ƒç´ çš„åä»£åˆ›å»º fiber èŠ‚ç‚¹
3. é€‰æ‹©ä¸‹ä¸€ä¸ªå•å…ƒä»»åŠ¡ï¼Œå¹¶è¿”å›

ä¸ºäº†å®Œæˆè¿™äº›ç›®æ ‡éœ€è¦è®¾è®¡çš„æ•°æ®ç»“æ„æ–¹ä¾¿æ‰¾åˆ°ä¸‹ä¸€ä¸ªä»»åŠ¡å•å…ƒã€‚**æ‰€ä»¥æ¯ä¸ª fiber ç›´æ¥é“¾æ¥å®ƒçš„ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹(child)ï¼Œå­èŠ‚ç‚¹é“¾æ¥å®ƒçš„å…„å¼ŸèŠ‚ç‚¹(sibling)ï¼Œå…„å¼ŸèŠ‚ç‚¹é“¾æ¥åˆ°çˆ¶èŠ‚ç‚¹(parent)ã€‚**ç¤ºæ„å›¾å¦‚ä¸‹(æ³¨æ„ä¸åŒèŠ‚ç‚¹ä¹‹é—´çš„é«˜äº®ç®­å¤´)ï¼š

<div style="background:#202226;max-width: 680px;margin: 0 auto;">
  <img src="./images/fiber1.png"></img>
</div>

å½“æˆ‘ä»¬å®Œæˆäº†ä¸€ä¸ª fiber çš„å•å…ƒä»»åŠ¡ï¼Œå¦‚æœä»–æœ‰ä¸€ä¸ª `å­èŠ‚ç‚¹/child` åˆ™è¿™ä¸ªèŠ‚ç‚¹ä½œä¸º `nextUnitOfWork`ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå½“å®Œæˆ `div` å•å…ƒä»»åŠ¡ä¹‹åï¼Œä¸‹ä¸€ä¸ªå•å…ƒä»»åŠ¡å°±æ˜¯ `h1`ã€‚

<div style="background:#202226;max-width: 680px;margin: 0 auto;">
  <img src="./images/fiber2.png"></img>
</div>

å¦‚æœä¸€ä¸ª fiber æ²¡æœ‰ `child`ï¼Œæˆ‘ä»¬ç”¨ `å…„å¼ŸèŠ‚ç‚¹/sibling` ä½œä¸ºä¸‹ä¸€ä¸ªä»»åŠ¡å•å…ƒã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œ`p` èŠ‚ç‚¹æ²¡æœ‰ `child` è€Œæœ‰ `sibling`ï¼Œæ‰€ä»¥ä¸‹ä¸€ä¸ªä»»åŠ¡å•å…ƒæ˜¯ `a` èŠ‚ç‚¹ã€‚

<div style="background:#202226;max-width: 680px;margin: 0 auto;">
  <img src="./images/fiber3.png"></img>
</div>

å¦‚æœä¸€ä¸ª fiber æ—¢æ²¡æœ‰ `child` ä¹Ÿæ²¡æœ‰ `sibling`ï¼Œåˆ™æ‰¾åˆ°çˆ¶èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹ï¼Œã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ `a` å’Œ `h2`ã€‚

<div style="background:#202226;max-width: 680px;margin: 0 auto;">
  <img src="./images/fiber4.png"></img>
</div>

å¦‚æœçˆ¶èŠ‚ç‚¹æ²¡æœ‰å…„å¼ŸèŠ‚ç‚¹ï¼Œåˆ™ç»§ç»­å¾€ä¸Šæ‰¾ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªå…„å¼ŸèŠ‚ç‚¹æˆ–è€…åˆ°è¾¾ fiber æ ¹ç»“ç‚¹ã€‚åˆ°è¾¾æ ¹ç»“ç‚¹å³æ„å‘³æœ¬æ¬¡ `render` ä»»åŠ¡å…¨éƒ¨å®Œæˆã€‚å­¦è¿‡ç®—æ³•çš„åŒå­¦å¯¹è¿™ä¸ªè¿‡ç¨‹è‚¯å®šå¾ˆç†Ÿæ‚‰ï¼Œè¿™æ˜¯å…¸å‹çš„æ·±åº¦ä¼˜å…ˆæœç´¢éå†ï¼ˆDFS/depth first searchï¼‰ã€‚

æŠŠè¿™ä¸ªæ€è·¯ç”¨ä»£ç è¡¨è¾¾å¦‚ä¸‹ï¼š

*æç¤ºï¼šä»£ç å‰åå·®å¼‚éƒ¨åˆ†å·²é«˜äº®*

```js {2-16,19-24,41-89}
// ä¹‹å‰ render çš„é€»è¾‘æŒªåˆ°è¿™ä¸ªå‡½æ•°
function createDom(fiber) {
  const dom =
    fiber.type == "TEXT_ELEMENT"
      ? document.createTextNode("")
      : document.createElement(fiber.type);

  const isProperty = key => key !== "children";
  Object.keys(fiber.props)
    .filter(isProperty)
    .forEach(name => {
      dom[name] = fiber.props[name];
    });

  return dom;
}
function render(element, container) {
  // åˆ›å»ºæ ¹ fiberï¼Œè®¾ä¸ºä¸‹ä¸€æ¬¡çš„å•å…ƒä»»åŠ¡
  nextUnitOfWork = {
    dom: container,
    props: {
      children: [element]
    }
  };
}

let nextUnitOfWork = null;
function workLoop(deadline) {
  let shouldYield = false;
  while (nextUnitOfWork && !shouldYield) {
    nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
    shouldYield = deadline.timeRemaining() < 1;
  }
  requestIdleCallback(workLoop);
}

// ä¸€æ—¦æµè§ˆå™¨ç©ºé—²ï¼Œå°±è§¦å‘æ‰§è¡Œå•å…ƒä»»åŠ¡
requestIdleCallback(workLoop);

function performUnitOfWork(fiber) {
  if (!fiber.dom) {
    fiber.dom = createDom(fiber);
  }

  // å­èŠ‚ç‚¹ DOM æ’åˆ°çˆ¶èŠ‚ç‚¹ä¹‹å
  if (fiber.parent) {
    fiber.parent.dom.appendChild(fiber.dom);
  }

  // ä¸ºæ¯ä¸ªå­å…ƒç´ åˆ›å»ºæ–°çš„ fiber
  const elements = fiber.props.children;
  let index = 0;
  let prevSibling = null;

  while (index < elements.length) {
    const element = elements[index];

    const newFiber = {
      type: element.type,
      props: element.props,
      parent: fiber,
      dom: null
    };
    // æ ¹æ®ä¸Šé¢çš„å›¾ç¤ºï¼Œçˆ¶èŠ‚ç‚¹åªé“¾æ¥ç¬¬ä¸€ä¸ªå­èŠ‚ç‚¹
    if (index === 0) {
      fiber.child = newFiber;
    } else {
      // å…„èŠ‚ç‚¹é“¾æ¥å¼ŸèŠ‚ç‚¹
      prevSibling.sibling = newFiber;
    }

    prevSibling = newFiber;
    index++;
  }
  // è¿”å›ä¸‹ä¸€ä¸ªä»»åŠ¡å•å…ƒï¼ˆfiberï¼‰
  // æœ‰å­èŠ‚ç‚¹ç›´æ¥è¿”å›
  if (fiber.child) {
    return fiber.child;
  }
  // æ²¡æœ‰å­èŠ‚ç‚¹åˆ™æ‰¾å…„å¼ŸèŠ‚ç‚¹ï¼Œå…„å¼ŸèŠ‚ç‚¹ä¹Ÿæ²¡æœ‰æ‰¾çˆ¶èŠ‚ç‚¹çš„å…„å¼ŸèŠ‚ç‚¹ï¼Œ
  // å¾ªç¯éå†ç›´è‡³æ‰¾åˆ°ä¸ºæ­¢
  let nextFiber = fiber;
  while (nextFiber) {
    if (nextFiber.sibling) {
      return nextFiber.sibling;
    }
    nextFiber = nextFiber.parent;
  }
  return null;
}
```

---

## V: render å’Œ commit é˜¶æ®µ

æˆ‘ä»¬çš„ä»£ç è¿˜æœ‰ä¸€ä¸ªé—®é¢˜ã€‚

æ¯å®Œæˆä¸€ä¸ªä»»åŠ¡å•å…ƒéƒ½æŠŠèŠ‚ç‚¹æ·»åŠ åˆ° DOM ä¸Šã€‚è¯·è®°ä½ï¼Œæµè§ˆå™¨æ˜¯å¯ä»¥æ‰“æ–­æ¸²æŸ“æµç¨‹çš„ï¼Œå¦‚æœè¿˜æ²¡æ¸²æŸ“å®Œæ•´æ£µæ ‘å°±æŠŠèŠ‚ç‚¹æ·»åŠ åˆ° DOMï¼Œç”¨æˆ·ä¼šçœ‹åˆ°æ®‹ç¼ºä¸å…¨çš„ UI ç•Œé¢ï¼Œç»™äººä¸€ç§å¾ˆä¸ä¸“ä¸šçš„å°è±¡ï¼Œè¿™è‚¯å®šä¸æ˜¯æˆ‘ä»¬æƒ³è¦çš„ã€‚å› æ­¤éœ€è¦é‡æ„èŠ‚ç‚¹æ·»åŠ åˆ° DOM è¿™éƒ¨åˆ†ä»£ç ï¼Œæ•´æ£µæ ‘ï¼ˆfiberï¼‰æ¸²æŸ“å®Œæˆä¹‹åå†ä¸€æ¬¡æ€§æ·»åŠ åˆ° DOMï¼Œå³ React commit é˜¶æ®µã€‚

å…·ä½“æ¥è¯´ï¼Œå»æ‰ `performUnitOfWork` çš„ `fiber.parent.dom.appendChild` ä»£ç ï¼Œæ¢æˆå¦‚ä¸‹ä»£ç ã€‚

```js {18-21,24-33,37,43,48,61-63}
function createDom(fiber) {
  const dom =
    fiber.type == "TEXT_ELEMENT"
      ? document.createTextNode("")
      : document.createElement(fiber.type);
â€‹
  const isProperty = key => key !== "children";
  Object.keys(fiber.props)
    .filter(isProperty)
    .forEach(name => {
      dom[name] = fiber.props[name];
    });
â€‹
  return dom;
}

// æ–°å¢å‡½æ•°ï¼Œæäº¤æ ¹ç»“ç‚¹åˆ° DOM
function commitRoot() {
  commitWork(wipRoot.child);
  wipRoot = null;
}
â€‹
// æ–°å¢å­å‡½æ•°
function commitWork(fiber) {
  if (!fiber) {
    return;
  }
  const domParent = fiber.parent.dom;
  domParent.appendChild(fiber.dom);
  // é€’å½’å­èŠ‚ç‚¹å’Œå…„å¼ŸèŠ‚ç‚¹
  commitWork(fiber.child);
  commitWork(fiber.sibling);
}

function render(element, container) {
  // render æ—¶è®°å½• wipRoot
  wipRoot = {
    dom: container,
    props: {
      children: [element],
    },
  };
  nextUnitOfWork = wipRoot;
}
â€‹
let nextUnitOfWork = null;
// æ–°å¢å˜é‡ï¼Œè·Ÿè¸ªæ¸²æŸ“è¿›è¡Œä¸­çš„æ ¹ fiber
let wipRoot = null;

function workLoop(deadline) {
  let shouldYield = false;
  while (nextUnitOfWork && !shouldYield) {
    nextUnitOfWork = performUnitOfWork(
      nextUnitOfWork
    );
    shouldYield = deadline.timeRemaining() < 1;
  }

  // å½“ nextUnitOfWork ä¸ºç©ºåˆ™è¡¨ç¤ºæ¸²æŸ“ fiber æ ‘å®Œæˆäº†ï¼Œ
  // å¯ä»¥æäº¤åˆ° DOM äº†
  if (!nextUnitOfWork && wipRoot) {
    commitRoot();
  }
  requestIdleCallback(workLoop);
}

â€‹// ä¸€æ—¦æµè§ˆå™¨ç©ºé—²ï¼Œå°±è§¦å‘æ‰§è¡Œå•å…ƒä»»åŠ¡
requestIdleCallback(workLoop);

function performUnitOfWork(fiber) {
  if (!fiber.dom) {
    fiber.dom = createDom(fiber);
  }

  const elements = fiber.props.children;
  let index = 0;
  let prevSibling = null;
â€‹
  while (index < elements.length) {
    const element = elements[index];
â€‹
    const newFiber = {
      type: element.type,
      props: element.props,
      parent: fiber,
      dom: null,
    };

    if (index === 0) {
      fiber.child = newFiber;
    } else {
      prevSibling.sibling = newFiber;
    }
â€‹
    prevSibling = newFiber;
    index++;
  }

  if (fiber.child) {
    return fiber.child;
  }

  let nextFiber = fiber;
  while (nextFiber) {
    if (nextFiber.sibling) {
      return nextFiber.sibling;
    }
    nextFiber = nextFiber.parent;
  }
}
```

---

## VI: æ›´æ–°å’Œåˆ é™¤èŠ‚ç‚¹/Reconciliation

ç›®å‰æˆ‘ä»¬åªæ·»åŠ èŠ‚ç‚¹åˆ° DOMï¼Œè¿˜æ²¡è€ƒè™‘æ›´æ–°å’Œåˆ é™¤èŠ‚ç‚¹çš„æƒ…å†µã€‚è¦å¤„ç†è¿™2ç§æƒ…å†µï¼Œéœ€è¦å¯¹æ¯”ä¸Šæ¬¡æ¸²æŸ“çš„ fiber å’Œå½“å‰æ¸²æŸ“çš„ fiber çš„å·®å¼‚ï¼Œæ ¹æ®å·®å¼‚å†³å®šæ˜¯æ›´æ–°è¿˜æ˜¯åˆ é™¤èŠ‚ç‚¹ã€‚React æŠŠè¿™ä¸ªè¿‡ç¨‹å« `Reconciliation`ã€‚

å› æ­¤æˆ‘ä»¬éœ€è¦ä¿å­˜ä¸Šä¸€æ¬¡æ¸²æŸ“ä¹‹åçš„ fiber æ ‘ï¼Œæˆ‘ä»¬æŠŠè¿™æ£µæ ‘å« `currentRoot`ã€‚åŒæ—¶ï¼Œç»™æ¯ä¸ª fiber èŠ‚ç‚¹æ·»åŠ  `alternate` å±æ€§ï¼ŒæŒ‡å‘ä¸Šä¸€æ¬¡æ¸²æŸ“çš„ fiberã€‚

ä»£ç è¾ƒå¤šï¼Œå»ºè®®æŒ‰ `render âŸ¶ workLoop âŸ¶ performUnitOfWork âŸ¶ reconcileChildren âŸ¶ workLoop âŸ¶ commitRoot âŸ¶ commitWork âŸ¶ updateDom` é¡ºåºé˜…è¯»ã€‚

```js {7,12-61,64,66,75-81,92,94,99,101,126,144,148-194}
function createDom(fiber) {
  const dom =
    fiber.type === "TEXT_ELEMENT"
      ? document.createTextNode("")
      : document.createElement(fiber.type);

  updateDom(dom, {}, fiber.props);

  return dom;
}

const isEvent = key => key.startsWith("on");
const isProperty = key => key !== "children" && !isEvent(key);
const isNew = (prev, next) => key => prev[key] !== next[key];
const isGone = (prev, next) => key => !(key in next);

// æ–°å¢å‡½æ•°ï¼Œæ›´æ–° DOM èŠ‚ç‚¹å±æ€§
function updateDom(dom, prevProps = {}, nextProps = {}) {
  // ä»¥ â€œonâ€ å¼€å¤´çš„å±æ€§ä½œä¸ºäº‹ä»¶è¦ç‰¹åˆ«å¤„ç†
  // ç§»é™¤æ—§çš„æˆ–è€…å˜åŒ–äº†çš„çš„äº‹ä»¶å¤„ç†å‡½æ•°
  Object.keys(prevProps)
    .filter(isEvent)
    .filter(key => !(key in nextProps) || isNew(prevProps, nextProps)(key))
    .forEach(name => {
      const eventType = name.toLowerCase().substring(2);
      dom.removeEventListener(eventType, prevProps[name]);
    });

  // ç§»é™¤æ—§çš„å±æ€§
  Object.keys(prevProps)
    .filter(isProperty)
    .filter(isGone(prevProps, nextProps))
    .forEach(name => {
      dom[name] = "";
    });

  // æ·»åŠ æˆ–è€…æ›´æ–°å±æ€§
  Object.keys(nextProps)
    .filter(isProperty)
    .filter(isNew(prevProps, nextProps))
    .forEach(name => {
      // React è§„å®š style å†…è”æ ·å¼æ˜¯é©¼å³°å‘½åçš„å¯¹è±¡ï¼Œ
      // æ ¹æ®è§„èŒƒç»™ style æ¯ä¸ªå±æ€§å•ç‹¬èµ‹å€¼
      if (name === "style") {
        Object.entries(nextProps[name]).forEach(([key, value]) => {
          dom.style[key] = value;
        });
      } else {
        dom[name] = nextProps[name];
      }
    });

  // æ·»åŠ æ–°çš„äº‹ä»¶å¤„ç†å‡½æ•°
  Object.keys(nextProps)
    .filter(isEvent)
    .filter(isNew(prevProps, nextProps))
    .forEach(name => {
      const eventType = name.toLowerCase().substring(2);
      dom.addEventListener(eventType, nextProps[name]);
    });
}

function commitRoot() {
  deletions.forEach(commitWork);
  commitWork(wipRoot.child);
  currentRoot = wipRoot;
  wipRoot = null;
}

function commitWork(fiber) {
  if (!fiber) {
    return;
  }
  const domParent = fiber.parent.dom;
  if (fiber.effectTag === "PLACEMENT" && fiber.dom != null) {
    domParent.appendChild(fiber.dom);
  } else if (fiber.effectTag === "UPDATE" && fiber.dom != null) {
    updateDom(fiber.dom, fiber.alternate.props, fiber.props);
  } else if (fiber.effectTag === "DELETION") {
    domParent.removeChild(fiber.dom);
  }
  commitWork(fiber.child);
  commitWork(fiber.sibling);
}

function render(element, container) {
  wipRoot = {
    dom: container,
    props: {
      children: [element]
    },
    alternate: currentRoot
  };
  deletions = [];
  nextUnitOfWork = wipRoot;
}

let nextUnitOfWork = null;
let currentRoot = null;
let wipRoot = null;
let deletions = null;

function workLoop(deadline) {
  let shouldYield = false;
  while (nextUnitOfWork && !shouldYield) {
    nextUnitOfWork = performUnitOfWork(nextUnitOfWork);
    shouldYield = deadline.timeRemaining() < 1;
  }

  if (!nextUnitOfWork && wipRoot) {
    commitRoot();
  }

  requestIdleCallback(workLoop);
}

requestIdleCallback(workLoop);

function performUnitOfWork(fiber) {
  if (!fiber.dom) {
    fiber.dom = createDom(fiber);
  }

  const elements = fiber.props.children;
  // åŸæœ¬æ·»åŠ  fiber çš„é€»è¾‘æŒªåˆ° reconcileChildren å‡½æ•°
  reconcileChildren(fiber, elements);

  if (fiber.child) {
    return fiber.child;
  }
  let nextFiber = fiber;
  while (nextFiber) {
    if (nextFiber.sibling) {
      return nextFiber.sibling;
    }
    nextFiber = nextFiber.parent;
  }
}

// æ–°å¢å‡½æ•°
function reconcileChildren(wipFiber, elements) {
  let index = 0;
  // ä¸Šæ¬¡æ¸²æŸ“å®Œæˆä¹‹åçš„ fiber èŠ‚ç‚¹
  let oldFiber = wipFiber.alternate && wipFiber.alternate.child;
  let prevSibling = null;

  // æ‰å¹³åŒ– props.childrenï¼Œå¤„ç†å‡½æ•°ç»„ä»¶çš„ children
  elements = elements.flat();

  while (index < elements.length || oldFiber != null) {
    // æœ¬æ¬¡éœ€è¦æ¸²æŸ“çš„å­å…ƒç´ 
    const element = elements[index];
    let newFiber = null;

    // æ¯”è¾ƒå½“å‰å’Œä¸Šä¸€æ¬¡æ¸²æŸ“çš„ typeï¼Œå³ DOM tag 'div'ï¼Œ
    // æš‚ä¸è€ƒè™‘è‡ªå®šä¹‰ç»„ä»¶
    const sameType = oldFiber && element && element.type === oldFiber.type;

    // åŒç±»å‹èŠ‚ç‚¹ï¼Œåªéœ€æ›´æ–°èŠ‚ç‚¹ props å³å¯
    if (sameType) {
      newFiber = {
        type: oldFiber.type,
        props: element.props,
        dom: oldFiber.dom, // å¤ç”¨æ—§èŠ‚ç‚¹çš„ DOM
        parent: wipFiber,
        alternate: oldFiber,
        effectTag: "UPDATE" // æ–°å¢å±æ€§ï¼Œåœ¨æäº¤/commit é˜¶æ®µä½¿ç”¨
      };
    }
    // ä¸åŒç±»å‹èŠ‚ç‚¹ä¸”å­˜åœ¨æ–°çš„å…ƒç´ æ—¶ï¼Œåˆ›å»ºæ–°çš„ DOM èŠ‚ç‚¹
    if (element && !sameType) {
      newFiber = {
        type: element.type,
        props: element.props,
        dom: null,
        parent: wipFiber,
        alternate: null,
        effectTag: "PLACEMENT" // PLACEMENT è¡¨ç¤ºéœ€è¦æ·»åŠ æ–°çš„èŠ‚ç‚¹
      };
    }
    // ä¸åŒç±»å‹èŠ‚ç‚¹ï¼Œä¸”å­˜åœ¨æ—§çš„ fiber èŠ‚ç‚¹æ—¶ï¼Œ
    // éœ€è¦ç§»é™¤è¯¥èŠ‚ç‚¹
    if (oldFiber && !sameType) {
      oldFiber.effectTag = "DELETION";
      // å½“æœ€åæäº¤ fiber æ ‘åˆ° DOM æ—¶ï¼Œæˆ‘ä»¬æ˜¯ä» wipRoot å¼€å§‹çš„ï¼Œ
      // æ­¤æ—¶æ²¡æœ‰ä¸Šä¸€æ¬¡çš„ fiberï¼Œæ‰€ä»¥è¿™é‡Œç”¨ä¸€ä¸ªæ•°ç»„æ¥è·Ÿè¸ªéœ€è¦
      // åˆ é™¤çš„èŠ‚ç‚¹
      deletions.push(oldFiber);
    }

    if (oldFiber) {
      // åŒæ­¥æ›´æ–°ä¸‹ä¸€ä¸ªæ—§ fiber èŠ‚ç‚¹
      oldFiber = oldFiber.sibling;
    }

    if (index === 0) {
      wipFiber.child = newFiber;
    } else {
      prevSibling.sibling = newFiber;
    }

    prevSibling = newFiber;
    index++;
  }
}
```

<Message>

  æ³¨æ„ï¼šè¿™ä¸ªè¿‡ç¨‹ä¸­ React è¿˜ç”¨äº† `key` æ¥æ£€æµ‹æ•°ç»„å…ƒç´ å˜åŒ–äº†ä½ç½®çš„æƒ…å†µï¼Œé¿å…é‡å¤æ¸²æŸ“ä»¥æé«˜æ€§èƒ½ã€‚ç®€åŒ–èµ·è§ï¼Œæœ¬æ–‡æœªå®ç°ã€‚

</Message>

ä¸‹é¢ CodeSandbox ä»£ç ç”¨äº†ä¸ªå°æŠ€å·§ï¼Œé‡å¤æ‰§è¡Œ `render` å®ç°æ›´æ–°ç•Œé¢çš„æ•ˆæœï¼Œè¾“å…¥å‡ ä¸ªå­—è¯•è¯•çœ‹æ•ˆæœã€‚

<iframe
  src="https://codesandbox.io/embed/redact-1-dovfc?fontsize=14&hidenavigation=1&theme=dark"
  style="width: 100%;max-width: 800px;; height:500px; border:0; border-radius: 4px; overflow:hidden;"
  title="redact-2"
  allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb"
  sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"
></iframe>

---

## VII: å‡½æ•°ç»„ä»¶

ç›®å‰æˆ‘ä»¬è¿˜åªè€ƒè™‘äº†ç›´æ¥æ¸²æŸ“ DOM æ ‡ç­¾çš„æƒ…å†µï¼Œä¸æ”¯æŒç»„ä»¶ï¼Œè€Œç»„ä»¶æ˜¯ React æ˜¯çµé­‚ï¼Œä¸‹é¢æˆ‘ä»¬æ¥å®ç°å‡½æ•°ç»„ä»¶ã€‚

ä»¥ä¸€ä¸ªéå¸¸ç®€å•çš„ç»„ä»¶ä»£ç ä¸ºä¾‹ã€‚

```jsx
/** @jsx Redact.createElement */
function App(props) {
  return <h1>Hi {props.name}</h1>;
};

// ç­‰æ•ˆ JS ä»£ç  ğŸ‘‡
function App(props) {
  return Redact.createElement(
    "h1",
    null,
    "Hi ",
    props.name
  );
}

const element = <App name="foo" />;
const container = document.getElementById("root");
Redact.render(element, container);
```

å‡½æ•°ç»„ä»¶æœ‰2ä¸ªä¸åŒç‚¹ï¼š
- å‡½æ•°ç»„ä»¶çš„ fiber èŠ‚ç‚¹æ²¡æœ‰å¯¹åº” DOM
- å‡½æ•°ç»„ä»¶çš„ children æ¥è‡ªå‡½æ•°æ‰§è¡Œç»“æœï¼Œè€Œä¸æ˜¯åƒæ ‡ç­¾å…ƒç´ ä¸€æ ·ç›´æ¥ä» props è·å–ï¼Œå› ä¸º children ä¸åªæ˜¯å‡½æ•°ç»„ä»¶ä½¿ç”¨æ—¶åŒ…å«çš„å­å­™èŠ‚ç‚¹ï¼Œè¿˜éœ€è¦ç»„åˆç»„ä»¶æœ¬èº«çš„ç»“æ„

æ³¨æ„ä»¥ä¸‹ä»£ç çœç•¥äº†æœªæ”¹åŠ¨éƒ¨åˆ†ã€‚

```js {8-11,19,27-35,40-44,58-70}
function commitWork(fiber) {
  if (!fiber) {
    return;
  }

  // å½“ fiber æ˜¯å‡½æ•°ç»„ä»¶æ—¶èŠ‚ç‚¹ä¸å­˜åœ¨ DOMï¼Œ
  // æ•…éœ€è¦éå†çˆ¶èŠ‚ç‚¹ä»¥æ‰¾åˆ°æœ€è¿‘çš„æœ‰ DOM çš„èŠ‚ç‚¹
  let domParentFiber = fiber.parent;
  while (!domParentFiber.dom) {
    domParentFiber = domParentFiber.parent;
  }
  const domParent = domParentFiber.dom;
  if (fiber.effectTag === "PLACEMENT" && fiber.dom != null) {
    domParent.appendChild(fiber.dom);
  } else if (fiber.effectTag === "UPDATE" && fiber.dom != null) {
    updateDom(fiber.dom, fiber.alternate.props, fiber.props);
  } else if (fiber.effectTag === "DELETION") {
    // ç›´æ¥ç§»é™¤ DOM æ›¿æ¢æˆ commitDeletion å‡½æ•°
    commitDeletion(fiber, domParent);
  }

  commitWork(fiber.child);
  commitWork(fiber.sibling);
}

// æ–°å¢å‡½æ•°ï¼Œç§»é™¤ DOM èŠ‚ç‚¹
function commitDeletion(fiber, domParent) {
  // å½“ child æ˜¯å‡½æ•°ç»„ä»¶æ—¶ä¸å­˜åœ¨ DOMï¼Œ
  // æ•…éœ€è¦é€’å½’éå†å­èŠ‚ç‚¹æ‰¾åˆ°çœŸæ­£çš„ DOM
  if (fiber.dom) {
    domParent.removeChild(fiber.dom);
  } else {
    commitDeletion(fiber.child, domParent);
  }
}

function performUnitOfWork(fiber) {
  const isFunctionComponent = fiber.type instanceof Function;
  // åŸæœ¬é€»è¾‘æŒªåˆ° updateHostComponent å‡½æ•°
  if (isFunctionComponent) {
    updateFunctionComponent(fiber);
  } else {
    updateHostComponent(fiber);
  }
  if (fiber.child) {
    return fiber.child;
  }
  let nextFiber = fiber;
  while (nextFiber) {
    if (nextFiber.sibling) {
      return nextFiber.sibling;
    }
    nextFiber = nextFiber.parent;
  }
}

// æ–°å¢å‡½æ•°ï¼Œå¤„ç†å‡½æ•°ç»„ä»¶
function updateFunctionComponent(fiber) {
  // æ‰§è¡Œå‡½æ•°ç»„ä»¶å¾—åˆ° children
  const children = [fiber.type(fiber.props)];
  reconcileChildren(fiber, children);
}

// æ–°å¢å‡½æ•°ï¼Œå¤„ç†åŸç”Ÿæ ‡ç­¾ç»„ä»¶
function updateHostComponent(fiber) {
  if (!fiber.dom) {
    fiber.dom = createDom(fiber);
  }
  reconcileChildren(fiber, fiber.props.children);
}
```

---

## VIII: å‡½æ•°ç»„ä»¶ Hooks

æ”¯æŒäº†å‡½æ•°ç»„ä»¶ï¼Œè¿˜éœ€è¦æ”¯æŒç»„ä»¶çŠ¶æ€ / state æ‰èƒ½å®ç°åˆ·æ–°ç•Œé¢ã€‚

æˆ‘ä»¬çš„ç¤ºä¾‹ä¹Ÿè·Ÿç€æ›´æ–°ï¼Œç”¨ hooks å®ç°ç»å…¸çš„ counterï¼Œç‚¹å‡»è®¡æ•°å™¨åŠ 1ã€‚

```jsx
/** @jsx Redact.createElement */
function Counter() {
  const [state, setState] = Redact.useState(1)
  return (
    <h1 onClick={() => setState(c => c + 1)}>
      Count: {state}
    </h1>
  );
}
const element = <Counter />;
const container = document.getElementById("root");
Redact.render(element, container);
```

æ³¨æ„ä»¥ä¸‹ä»£ç çœç•¥äº†æœªå˜åŒ–éƒ¨åˆ†ã€‚

```js
// æ–°å¢å˜é‡ï¼Œæ¸²æŸ“è¿›è¡Œä¸­çš„ fiber èŠ‚ç‚¹
let wipFiber = null;
// æ–°å¢å˜é‡ï¼Œå½“å‰ hook çš„ç´¢å¼•ï¼Œä»¥æ”¯æŒåŒä¸€ä¸ªå‡½æ•°ç»„ä»¶å¤šæ¬¡è°ƒç”¨ useState
let hookIndex = null;

function updateFunctionComponent(fiber) {
  // æ›´æ–°è¿›è¡Œä¸­çš„ fiber èŠ‚ç‚¹
  wipFiber = fiber;
  // é‡ç½® hook ç´¢å¼•
  hookIndex = 0;
  // æ–°å¢ hooks æ•°ç»„ä»¥æ”¯æŒåŒä¸€ä¸ªç»„ä»¶å¤šæ¬¡è°ƒç”¨ useState
  wipFiber.hooks = [];
  const children = [fiber.type(fiber.props)];
  reconcileChildren(fiber, children);
}

function useState(initial) {
  // alternate ä¿å­˜äº†ä¸Šä¸€æ¬¡æ¸²æŸ“çš„ fiber èŠ‚ç‚¹
  const oldHook =
    wipFiber.alternate &&
    wipFiber.alternate.hooks &&
    wipFiber.alternate.hooks[hookIndex];
  const hook = {
    // ç¬¬ä¸€æ¬¡æ¸²æŸ“ä½¿ç”¨å…¥å‚ï¼Œç¬¬äºŒæ¬¡æ¸²æŸ“å¤ç”¨å‰ä¸€æ¬¡çš„çŠ¶æ€
    state: oldHook ? oldHook.state : initial,
    // ä¿å­˜æ¯æ¬¡ setState å…¥å‚çš„é˜Ÿåˆ—
    queue: []
  };

  const actions = oldHook ? oldHook.queue : [];
  actions.forEach(action => {
    // æ ¹æ®è°ƒç”¨ setState é¡ºåºä»å‰å¾€åç”Ÿæˆæœ€æ–°çš„ state
    hook.state = action instanceof Function ? action(hook.state) : action;
  });

  // setState å‡½æ•°ç”¨äºæ›´æ–° stateï¼Œå…¥å‚ action
  // æ˜¯æ–°çš„ state å€¼æˆ–å‡½æ•°è¿”å›æ–°çš„ state
  const setState = action => {
    hook.queue.push(action);
    // ä¸‹é¢è¿™éƒ¨åˆ†ä»£ç å’Œ render å‡½æ•°å¾ˆåƒï¼Œ
    // è®¾ç½®æ–°çš„ wipRoot å’Œ nextUnitOfWork
    // æµè§ˆå™¨ç©ºé—²æ—¶å³å¼€å§‹é‡æ–°æ¸²æŸ“ã€‚
    wipRoot = {
      dom: currentRoot.dom,
      props: currentRoot.props,
      alternate: currentRoot
    };
    nextUnitOfWork = wipRoot;
    deletions = [];
  };

  // ä¿å­˜æœ¬æ¬¡ hook
  wipFiber.hooks.push(hook);
  hookIndex++;
  return [hook.state, setState];
}
```

å®Œæ•´ CodeSandbox ä»£ç å¦‚ä¸‹ï¼Œç‚¹å‡» Count è¯•è¯•ï¼š

<iframe
  src="https://codesandbox.io/embed/redact-2-rx063?fontsize=14&hidenavigation=1&theme=dark"
  style="width: 100%;max-width: 800px;; height:500px; border:0; border-radius: 4px; overflow:hidden;"
  title="redact-3"
  allow="geolocation; microphone; camera; midi; vr; accelerometer; gyroscope; payment; ambient-light-sensor; encrypted-media; usb"
  sandbox="allow-modals allow-forms allow-popups allow-scripts allow-same-origin"
></iframe>

---

## ç»“è¯­

é™¤äº†å¸®åŠ©è¯»è€…ç†è§£ React æ ¸å¿ƒå·¥ä½œåŸç†å¤–ï¼Œæœ¬æ–‡å¾ˆå¤šå˜é‡éƒ½å’Œ React å®˜æ–¹ä»£ç ä¿æŒä¸€è‡´ï¼Œæ¯”å¦‚ï¼Œè¯»è€…åœ¨ React åº”ç”¨çš„ä»»ä½•å‡½æ•°ç»„ä»¶é‡Œæ–­ç‚¹ï¼Œå†æ‰“å¼€è°ƒè¯•å·¥ä½œèƒ½çœ‹åˆ°ä¸‹é¢è¿™æ ·çš„è°ƒç”¨æ ˆï¼š

- updateFunctionComponent
- performUnitOfWork
- workLoop

![call stack](./images/stack.png)

æ³¨æ„æœ¬æ–‡æ˜¯æ•™å­¦æ€§è´¨çš„ï¼Œè¿˜ç¼ºå°‘å¾ˆå¤š React çš„åŠŸèƒ½å’Œæ€§èƒ½ä¼˜åŒ–ã€‚æ¯”å¦‚ï¼šåœ¨è¿™äº›äº‹æƒ…ä¸Š React çš„è¡¨ç°å’Œ Redact ä¸åŒã€‚

- Redact åœ¨æ¸²æŸ“é˜¶æ®µéå†äº†æ•´æ£µæ ‘ï¼Œè€Œ React ç”¨äº†ä¸€äº›å¯å‘æ€§ç®—æ³•ï¼Œå¯ä»¥ç›´æ¥è·³è¿‡æŸäº›æ²¡æœ‰å˜åŒ–çš„å­æ ‘ï¼Œä»¥æé«˜æ€§èƒ½ã€‚ï¼ˆæ¯”å¦‚ React æ•°ç»„å…ƒç´ æ¨èå¸¦ keyï¼Œå¯ä»¥è·³è¿‡æ— éœ€æ›´æ–°çš„èŠ‚ç‚¹ï¼Œå‚è€ƒ[å®˜æ–¹æ–‡æ¡£](https://zh-hans.reactjs.org/docs/reconciliation.html#keys)ï¼‰
- Redact åœ¨ commit é˜¶æ®µéå†æ•´æ£µæ ‘ï¼Œ React ç”¨äº†ä¸€ä¸ªé“¾è¡¨ä¿å­˜å˜åŒ–äº†çš„ fiberï¼Œå‡å°‘äº†å¾ˆå¤šä¸å¿…è¦éå†æ“ä½œã€‚
- Redact æ¯æ¬¡åˆ›å»ºæ–°çš„ fiber æ ‘æ—¶éƒ½æ˜¯ç›´æ¥åˆ›å»º fiber å¯¹è±¡èŠ‚ç‚¹ï¼Œè€Œ React ä¼šå¤ç”¨ä¸Šä¸€ä¸ª fiber å¯¹è±¡ï¼Œä»¥èŠ‚çœåˆ›å»ºå¯¹è±¡çš„æ€§èƒ½æ¶ˆè€—ã€‚
- Redact å¦‚æœåœ¨æ¸²æŸ“é˜¶æ®µæ”¶åˆ°æ–°çš„æ›´æ–°ä¼šç›´æ¥ä¸¢å¼ƒå·²æ¸²æŸ“çš„æ ‘ï¼Œå†ä»å¤´å¼€å§‹æ¸²æŸ“ã€‚è€Œ React ä¼šç”¨æ—¶é—´æˆ³æ ‡è®°æ¯æ¬¡æ›´æ–°ï¼Œä»¥å†³å®šæ›´æ–°çš„ä¼˜å…ˆçº§ã€‚
- æºç è¿˜æœ‰å¾ˆå¤šä¼˜åŒ–ç­‰å¾…è¯»è€…å»å‘ç°ã€‚ã€‚ã€‚

---

## å‚è€ƒ

å¾å¾—åŸä½œè€…åŒæ„ï¼Œæœ¬æ–‡å‚è€ƒäº† [build-your-own-react](https://pomb.us/build-your-own-react/) éƒ¨åˆ†å†…å®¹ï¼Œæ¨èè‹±æ–‡æ°´å¹³ä¸é”™è¯»è€…ç›´æ¥åœ¨æ¡Œé¢ç«¯é˜…è¯»åŸæ–‡ä»¥è·å¾—æœ€ä½³é˜…è¯»ä½“éªŒã€‚

- [build your own react](https://pomb.us/build-your-own-react/)
- [wtf is jsx](https://jasonformat.com/wtf-is-jsx/)
- [gooact react in 160 lines of javascript](https://medium.com/@sweetpalma/gooact-react-in-160-lines-of-javascript-44e0742ad60f)
